// ============================================
// KOACH - Prisma Schema
// ============================================
// Database: PostgreSQL
// ORM: Prisma v5.9.1

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Connection Pooler (puerto 6543) - Queries normales
  //directUrl = env("DIRECT_URL")      // Comentado temporalmente para db:push
}

// ============================================
// MODEL: Song
// ============================================
// Almacena las canciones disponibles para karaoke
// con su melod铆a de referencia y metadatos
model Song {
  id       String @id @default(uuid())
  title    String
  artist   String
  bpm      Int // Tempo de la canci贸n
  key      String // Tonalidad (ej: "C", "Am", "G#")
  audioUrl String // URL del instrumental (backing track)

  // Datos cr铆ticos de la melod铆a para comparaci贸n
  // Estructura: { notes: [{ start: number, end: number, note: string, frequency: number }] }
  melodyData Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  sessions Session[]

  @@map("songs")
}

// ============================================
// MODEL: Session
// ============================================
// Representa una sesi贸n de pr谩ctica de un usuario
model Session {
  id       String @id @default(uuid())
  songId   String
  userName String // Nombre del usuario (compatibilidad legacy)
  userId   String? //  Relaci贸n con usuario autenticado (opcional)
  score    Int // Puntaje final (0-100) calculado por Sistema Experto
  feedback String @db.Text // Retroalimentaci贸n textual generada

  //  Telemetr铆a avanzada del Sistema Experto
  // Estructura: SessionTelemetry (15+ m茅tricas de performance)
  telemetry Json?

  //  An谩lisis de performance (scores de pitch, stability, timing)
  // Estructura: PerformanceFeedback (pitchAccuracy, stability, timing)
  analysis Json?

  //  Diagn贸stico vocal generado por el Sistema Experto
  // Estructura: VocalDiagnosis (problema, prescripci贸n, severidad)
  diagnosis Json?

  createdAt DateTime @default(now())

  // Relaciones
  song           Song            @relation(fields: [songId], references: [id], onDelete: Cascade)
  user           User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  performanceLog PerformanceLog?

  @@index([userId])
  @@map("sessions")
}

// ============================================
// MODEL: User
// ============================================
// Sistema de autenticaci贸n de usuarios
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  
  //  VOCAL PROFILE - Datos del test de rango vocal
  vocalRange       String?  // ej: "C3 - G5" (rango completo)
  voiceType        String?  // ej: "baritone", "soprano", "tenor"
  lowestNote       String?  // Nota m谩s grave detectada
  highestNote      String?  // Nota m谩s aguda detectada  
  comfortableRange Json?    // [nota_baja, nota_alta] del rango c贸modo
  vocalRangeSemitones Int?  // Rango en semitonos
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  sessions        Session[]       //  Sesiones del usuario
  performanceLogs PerformanceLog[]

  @@index([email])
  @@map("users")
}

// ============================================
// MODEL: PerformanceLog
// ============================================
// Almacena los datos RAW de detecci贸n de pitch
// durante una sesi贸n para an谩lisis posterior
model PerformanceLog {
  id        String @id @default(uuid())
  sessionId String @unique

  // 锔 userId OPCIONAL para mantener compatibilidad con registros antiguos
  userId String?

  // Datos crudos de detecci贸n (Hz detectados por ml5/Web Audio)
  // Estructura: [{ timestamp: number, detectedFrequency: number, targetFrequency: number, targetNote: string }]
  rawData Json

  createdAt DateTime @default(now())

  // Relaciones
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("performance_logs")
}
